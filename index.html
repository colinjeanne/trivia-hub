<!doctype html>
<html>
    <head>
        <title>Trivia Hub</title>
        <meta charset="utf-8">
        <script src="./js/dataChannel.js"></script>
        <script>
            const SERVER_URL = "wss://nameless-waters-54140.herokuapp.com/";
        </script>
    </head>
    <body>
        <button id="button">Start Game</button>
        <div id="game" hidden="true">
            <div>Active: <span id="active"></span></div>
            <div>Timer: <span id="timer"></span></div>
            <p id="question"></p>
            <ol>
                <li id="a1"></li>
                <li id="a2"></li>
                <li id="a3"></li>
            </ol>
        </div>
        <script>
            document.getElementById("button").addEventListener("click", tryGame);

            const gameEl = document.getElementById("game");
            const activeEl = document.getElementById("active");
            const timerEl = document.getElementById("timer");
            const questionEl = document.getElementById("question");
            const a1El = document.getElementById("a1");
            const a2El = document.getElementById("a2");
            const a3El = document.getElementById("a3");

            let timeLeft = null;

            a1El.addEventListener("click", () => {
                socket.send(JSON.stringify({ type: "answer", answerIndex: 0 }));
            });

            a2El.addEventListener("click", () => {
                socket.send(JSON.stringify({ type: "answer", answerIndex: 1 }));
            });

            a3El.addEventListener("click", () => {
                socket.send(JSON.stringify({ type: "answer", answerIndex: 2 }));
            });

            let timerId = null;
            function updateTimer() {
                timeLeft -= 100;
                if (timeLeft <= 0) {
                    timeLeft = 0;
                    clearInterval(timerId);
                    timerId = null;
                }

                timerEl.textContent = (timeLeft / 1000).toFixed(1);
            }

            function tryGame() {
                const dataChannel = new DataChannel(SERVER_URL, "Washington");
                dataChannel.addEventListener("connected", () => {
                    console.log("Connected!");
                    dataChannel.joinGame();
                });
                dataChannel.addEventListener("error", () => cosole.log("ERROR"));

                dataChannel.addEventListener("start", () => {});
                dataChannel.addEventListener("question", (event) => {
                    questionEl.textContent = event.question;
                    a1.textContent = event.answers[0];
                    a2.textContent = event.answers[1];
                    a3.textContent = event.answers[2];
                    timeLeft = null;
                });
                dataChannel.addEventListener("countDown", (event) => {
                    if (timeLeft === null) {
                        timerId = setInterval(updateTimer, 100);
                    } else if (event.timeLeft === 0) {
                        clearInterval(timerId);
                    }

                    timeLeft = event.timeLeft;
                });
                dataChannel.addEventListener("results", (event) => {
                    timeLeft = null;
                    if (event.eliminated) {
                        activeEl.textContent = "False";
                    }
                });
                dataChannel.addEventListener("end", (event) => {
                    console.log("Game end");
                });
                dataChannel.connect();
                gameEl.hidden = false;
                activeEl.textContent = "True";
            }
        </script>
    </body>
</html>
